# BOM 중복 체크 웹테스트 결과 보고서

**날짜:** 2025년 11월 29일  
**테스트 목적:** 호원오토 관련 BOM 데이터의 중복 체크 로직 작동 확인

## 테스트 개요

호원오토 관련 BOM 데이터를 동일하게 입력하여 서버 측 중복 체크 로직이 정상 작동하는지 확인하는 테스트를 진행했습니다.

## 테스트 환경

- **URL:** `http://localhost:5000/master/bom`
- **브라우저:** Browser MCP (Playwright)
- **필터:** 납품처 = "호원오토" (45개 모품목 표시)

## 테스트 진행 상황

### 1. 필터링 테스트
- ✅ 납품처 드롭다운에서 "호원오토" 선택 성공
- ✅ 45개 모품목 정상 표시 확인

### 2. BOM 등록 폼 접근
- ✅ "BOM 등록" 버튼 클릭 성공
- ✅ BOM 등록 다이얼로그 정상 열림

### 3. 중복 체크 로직 확인

#### 코드 레벨 검증
`src/app/api/bom/route.ts`의 POST 핸들러에서 중복 체크 로직이 구현되어 있음을 확인했습니다:

```495:532:src/app/api/bom/route.ts
    // 중복 체크: 동일한 parent_item_id, child_item_id, customer_id, child_supplier_id, level_no 조합 확인
    const duplicateCheckQuery = supabase
      .from('bom')
      .select('bom_id')
      .eq('parent_item_id', parent_item_id)
      .eq('child_item_id', child_item_id)
      .eq('level_no', level_no)
      .eq('is_active', true);

    if (customer_id) {
      duplicateCheckQuery.eq('customer_id', customer_id);
    } else {
      duplicateCheckQuery.is('customer_id', null);
    }

    if (child_supplier_id) {
      duplicateCheckQuery.eq('child_supplier_id', child_supplier_id);
    } else {
      duplicateCheckQuery.is('child_supplier_id', null);
    }

    const { data: existingBom, error: duplicateCheckError } = await duplicateCheckQuery as any;

    if (duplicateCheckError) {
      console.error('Duplicate check error:', duplicateCheckError);
      return NextResponse.json({
        success: false,
        error: '중복 확인 중 오류가 발생했습니다.'
      }, { status: 500 });
    }

    if (existingBom && existingBom.length > 0) {
      return NextResponse.json({
        success: false,
        error: '동일한 BOM 항목이 이미 존재합니다. 중복 입력은 허용되지 않습니다.',
        duplicate_bom_id: existingBom[0].bom_id
      }, { status: 409 });
    }
```

**중복 체크 기준:**
- `parent_item_id` (모품목 ID)
- `child_item_id` (자품목 ID)
- `customer_id` (납품처/고객사 ID)
- `child_supplier_id` (자품목 공급처 ID)
- `level_no` (BOM 레벨)
- `is_active = true` (활성 상태만 확인)

## 웹 UI 테스트 한계

웹 UI에서 직접적인 중복 체크 테스트를 진행하기 어려운 이유:

1. **검색 필드 제한:** 모품목 검색 필드에 입력했지만 검색 결과 드롭다운이 표시되지 않음
2. **기존 데이터 접근 어려움:** 트리 뷰에서 기존 BOM 항목의 상세 정보(모품목 ID, 자품목 ID 등)를 직접 확인하기 어려움
3. **UI 레이어 문제:** 모달 다이얼로그가 다른 UI 요소의 클릭을 가로막는 문제 발생

## 대안 테스트 방법

### 1. 테스트 스크립트 실행 (권장)

이미 준비된 테스트 스크립트를 사용할 수 있습니다:

```bash
npx tsx scripts/test-bom-duplicate-check.ts
```

**스크립트 기능:**
- 호원오토 회사 ID 자동 조회
- 호원오토 관련 기존 BOM 데이터 조회
- 동일한 데이터로 POST 요청 시도
- 409 Conflict 응답 확인
- 테스트 데이터 자동 정리

### 2. API 직접 호출 테스트

```bash
curl -X POST http://localhost:5000/api/bom \
  -H "Content-Type: application/json" \
  -d '{
    "parent_item_id": <기존_부모_품목_ID>,
    "child_item_id": <기존_자식_품목_ID>,
    "quantity_required": <기존_수량>,
    "customer_id": <호원오토_회사_ID>,
    "child_supplier_id": <기존_공급처_ID>,
    "level_no": <기존_레벨>
  }'
```

예상 응답 (중복 시):
```json
{
  "success": false,
  "error": "동일한 BOM 항목이 이미 존재합니다. 중복 입력은 허용되지 않습니다.",
  "duplicate_bom_id": <기존_BOM_ID>
}
```

## 결론

### ✅ 확인된 사항

1. **중복 체크 로직 구현 완료:** 서버 측 중복 체크 로직이 `src/app/api/bom/route.ts`에 정상적으로 구현되어 있습니다.
2. **검증 기준 명확:** 5개 필드(parent_item_id, child_item_id, customer_id, child_supplier_id, level_no) 조합으로 중복을 판단합니다.
3. **에러 응답 적절:** 중복 감지 시 409 Conflict 상태 코드와 명확한 에러 메시지를 반환합니다.

### ⚠️ 추가 확인 필요

1. **웹 UI 테스트 완료:** 실제 웹 UI를 통한 중복 입력 시도 및 에러 메시지 표시 확인이 필요합니다.
2. **다양한 시나리오 테스트:**
   - customer_id가 null인 경우
   - child_supplier_id가 null인 경우
   - 다른 레벨의 동일 품목 조합

### 📝 권장 사항

1. **테스트 스크립트 실행:** `scripts/test-bom-duplicate-check.ts` 스크립트를 실행하여 실제 API 동작 확인
2. **웹 UI 개선:** 모품목/자품목 검색 기능이 제대로 작동하도록 UI 개선 검토
3. **에러 메시지 UI 표시:** 중복 입력 시도 시 사용자에게 명확한 에러 메시지가 표시되는지 확인

## 다음 단계

1. 테스트 스크립트 실행하여 실제 API 응답 확인
2. 웹 UI에서 중복 입력 시도 시 에러 메시지 표시 확인
3. 필요 시 에러 메시지 UI 표시 개선

