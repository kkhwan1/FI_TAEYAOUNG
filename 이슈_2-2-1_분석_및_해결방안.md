# 이슈 2-2-1: 공정별 모품목 리스트 분리 분석 및 해결 방안

**이슈**: 프레스 공정별 모품목(Parent Item) 리스트 분리  
**작성일**: 2025-11-29  
**상태**: ⏳ 분석 완료, 구현 필요

---

## 현재 상황 분석

### 구현된 기능
1. ✅ 프레스 용량 선택 드롭다운 (400톤, 600톤, 800톤, 1000톤, 1600톤)
2. ✅ 프레스 공정 선택 체크박스
3. ✅ 고객사 선택 기능
4. ✅ 고객사별 모품목 조회 API (`/api/items/by-customer`)

### 문제점
1. ❌ 프레스 용량 선택 후 모품목 필터링 로직 없음
2. ❌ 블랭킹/성형 구분 정보가 DB 스키마에 없음
3. ❌ 용량별 모품목 구분 데이터 부재

---

## 요구사항

### 공정별 분류
- **블랭킹(Blanking)**: 400~600톤
  - 400톤: 블랭킹용
  - 600톤: 블랭킹용
  
- **성형(Stamping)**: 1000~1600톤
  - 1000톤: 성형용
  - 1600톤: 성형용

- **기타**: 800톤 (분류 불명확)

### 예상 동작
1. 프레스 용량 선택 시:
   - 400톤 또는 600톤 선택 → 블랭킹용 모품목만 표시
   - 1000톤 또는 1600톤 선택 → 성형용 모품목만 표시
   - 800톤 선택 → ? (명확하지 않음)

---

## 현재 코드 구조

### ProductionEntryForm.tsx
```typescript
// 프레스 용량 상태
const [pressCapacity, setPressCapacity] = useState<number | undefined>(undefined);

// 모품목 조회 (고객사 기반)
useEffect(() => {
  if (processTypes.includes('프레스')) {
    if (customerId) {
      // 고객사별 모품목 조회
      const response = await fetch(`/api/items/by-customer?customer_id=${customerId}&limit=1000`);
      // 용량 필터링 없음
    }
  }
}, [processTypes, customerId]);
```

**문제**: `pressCapacity`가 변경되어도 모품목 필터링이 되지 않음

---

## 해결 방안

### 방안 1: 품목 테이블에 프레스 공정 타입 필드 추가 (권장)

**장점**:
- 명확한 데이터 구조
- 확장 가능
- 쿼리 최적화 용이

**단점**:
- DB 스키마 변경 필요
- 기존 데이터 마이그레이션 필요

**구현 방법**:
1. `items` 테이블에 `press_process_type` 필드 추가
   - 값: `'BLANKING'` | `'STAMPING'` | `null`
2. 품목 등록/수정 시 프레스 공정 타입 선택
3. API 필터링 로직 추가
4. 프론트엔드에서 용량 선택 시 필터링

### 방안 2: BOM 테이블에 프레스 용량 정보 추가

**장점**:
- BOM별로 다른 용량 사용 가능
- 더 유연한 구조

**단점**:
- BOM 테이블 구조 변경 필요
- 복잡도 증가

### 방안 3: 품목 코드/명 패턴으로 구분 (임시)

**장점**:
- DB 변경 없이 즉시 적용 가능

**단점**:
- 패턴이 명확하지 않으면 부정확
- 유지보수 어려움

---

## 권장 구현 방안 (방안 1)

### 1단계: DB 스키마 변경

```sql
-- items 테이블에 프레스 공정 타입 필드 추가
ALTER TABLE items 
ADD COLUMN press_process_type VARCHAR(20) 
CHECK (press_process_type IN ('BLANKING', 'STAMPING') OR press_process_type IS NULL);

-- 인덱스 추가 (성능 최적화)
CREATE INDEX idx_items_press_process_type ON items(press_process_type) 
WHERE press_process_type IS NOT NULL;
```

### 2단계: API 필터링 로직 추가

**파일**: `src/app/api/items/by-customer/route.ts`

```typescript
// 프레스 용량 파라미터 추가
const pressCapacity = searchParams.get('press_capacity');

// 필터링 로직
if (pressCapacity) {
  const capacity = parseInt(pressCapacity);
  if (capacity >= 400 && capacity <= 600) {
    // 블랭킹: 400~600톤
    query = query.eq('press_process_type', 'BLANKING');
  } else if (capacity >= 1000 && capacity <= 1600) {
    // 성형: 1000~1600톤
    query = query.eq('press_process_type', 'STAMPING');
  }
}
```

### 3단계: 프론트엔드 필터링 로직 추가

**파일**: `src/components/production/ProductionEntryForm.tsx`

```typescript
useEffect(() => {
  const fetchItems = async () => {
    if (processTypes.includes('프레스') && customerId) {
      let url = `/api/items/by-customer?customer_id=${customerId}&limit=1000`;
      
      // 프레스 용량에 따른 필터링 추가
      if (pressCapacity) {
        url += `&press_capacity=${pressCapacity}`;
      }
      
      const response = await fetch(url);
      // ...
    }
  };
  
  fetchItems();
}, [processTypes, customerId, pressCapacity]); // pressCapacity 의존성 추가
```

---

## 즉시 적용 가능한 임시 방안

DB 변경이 어려운 경우, 프론트엔드에서 용량 선택 시 사용자에게 안내만 추가:

1. 용량 선택 시 안내 메시지 표시
2. 모품목 리스트는 고객사별로만 필터링
3. 추후 DB 구조 개선 후 실제 필터링 구현

---

## 확인 필요 사항

1. **DB 스키마 확인**:
   - 품목 테이블에 프레스 공정 타입 필드가 실제로 있는지
   - 또는 다른 방법으로 구분이 가능한지

2. **데이터 확인**:
   - 실제 데이터에서 블랭킹/성형 구분이 어떻게 되어 있는지
   - 품목 코드나 명명 규칙으로 구분 가능한지

3. **비즈니스 로직 확인**:
   - 800톤은 어느 공정에 속하는지
   - 블랭킹과 성형의 명확한 구분 기준

---

## 다음 단계

1. ✅ 현재 코드 구조 분석 완료
2. ⏳ DB 스키마 및 데이터 확인 필요
3. ⏳ 비즈니스 로직 확인 필요
4. ⏳ 구현 방안 결정 후 개발 진행

---

**현재 상태**: 분석 완료, DB 확인 및 구현 방안 결정 필요

