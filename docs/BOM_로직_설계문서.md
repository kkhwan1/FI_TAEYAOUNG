# BOM 로직 설계 문서

> 작성일: 2025-11-30
> 프로젝트: FITaeYoungERP

---

## 1. 개요

BOM(Bill of Materials)은 제품을 구성하는 부품/자재 목록을 관리하는 핵심 모듈입니다. 본 문서는 BOM 모듈의 데이터 입력 정책과 검증 로직을 정의합니다.

---

## 2. 중복 입력 정책

### 2.1 현재 정책: 중복 입력 허용

| 항목 | 허용 여부 | 설명 |
|------|----------|------|
| **완전 중복** | O 허용 | 같은 (부모품목, 자품목) 조합 여러 번 입력 가능 |
| **자기 참조** | X 불가 | `parent_item_id = child_item_id` 불가능 |
| **순환 참조** | O 허용 | A→B→C→A 형태 가능 |

### 2.2 정책 결정 근거

- 같은 품목 조합이라도 납품처, 공급처, 차종에 따라 다른 BOM 항목으로 관리 필요
- 동일 조합의 다른 단가/조건 관리 가능
- DB에는 중복 저장하되, UI에서 필터링하여 표시

### 2.3 관련 코드 위치

```
src/app/api/bom/route.ts
├── 라인 369-372: POST 핸들러 정책 주석
├── 라인 495: POST 핸들러 정책 주석
└── 라인 703: PUT 핸들러 정책 주석
```

---

## 3. 순환 참조 정책

### 3.1 현재 정책: 순환 참조 허용

순환 참조 검사 함수는 존재하나 **비활성화** 상태입니다.

### 3.2 관련 코드

**파일**: `src/lib/bom.ts` (라인 40-49)

```typescript
export async function checkBomCircular(
  conn: any,
  parentId: number,
  childId: number,
  excludeBomId?: number
): Promise<boolean> {
  // 순환 참조 허용: 모든 순환 참조(자기 참조 포함)를 허용함
  // 항상 false를 반환하여 순환 참조 검사를 비활성화
  return false;
}
```

---

## 4. 검증 항목

### 4.1 API 레벨 검증 (route.ts)

| 검증 항목 | 상태 | 코드 위치 | 에러 메시지 |
|----------|------|----------|------------|
| 필수값 검증 | O 활성 | 362-367 | "부모 품목, 자식 품목, 소요수량은 필수입니다" |
| 소요량 > 0 | O 활성 | 375-378 | "소요량은 0보다 커야 합니다" |
| 부모 품목 존재 | O 활성 | 394-406 | "부모 품목을 찾을 수 없습니다" |
| 부모 품목 활성화 | O 활성 | 407-411 | "비활성화된 부모 품목입니다" |
| 자식 품목 존재 | O 활성 | 415-426 | "자식 품목을 찾을 수 없습니다" |
| 자식 품목 활성화 | O 활성 | 427-431 | "비활성화된 자식 품목입니다" |
| 자기 참조 방지 | O 활성 | 387-392 | "부모 품목과 자식 품목이 같을 수 없습니다" |
| 납품처 검증 | O 활성 | 436-463 | "납품처(고객사)를 찾을 수 없습니다" |
| 공급처 검증 | O 활성 | 466-493 | "공급처를 찾을 수 없습니다" |
| **중복 입력** | X 없음 | - | - |
| **순환 참조** | X 비활성 | - | - |

### 4.2 프론트엔드 검증 (BOMForm.tsx)

| 검증 항목 | 상태 | 코드 위치 |
|----------|------|----------|
| 모품목 필수 | O 활성 | 라인 236-238 |
| 자품목 필수 | O 활성 | 라인 239-241 |
| 소요량 > 0 | O 활성 | 라인 243-245 |
| 레벨 1-10 | O 활성 | 라인 246-248 |
| 자기 참조 필터 | O 활성 | 라인 220-222 |

---

## 5. API 엔드포인트

### 5.1 BOM CRUD API

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/bom` | BOM 목록 조회 |
| GET | `/api/bom?bom_id={id}` | 단일 BOM 조회 |
| POST | `/api/bom` | BOM 등록 |
| PUT | `/api/bom` | BOM 수정 |
| DELETE | `/api/bom?bom_id={id}` | BOM 삭제 |

### 5.2 요청/응답 형식

**POST/PUT 요청 Body**:
```json
{
  "parent_item_id": 123,
  "child_item_id": 456,
  "quantity_required": 1.0,
  "level_no": 1,
  "customer_id": 789,
  "child_supplier_id": 101,
  "vehicle_model": "차종명",
  "notes": "비고"
}
```

---

## 6. 관련 파일

### 6.1 핵심 파일

| 파일 | 역할 |
|------|------|
| `src/app/api/bom/route.ts` | BOM API 엔드포인트 |
| `src/lib/bom.ts` | BOM 유틸리티 함수 |
| `src/components/BOMForm.tsx` | BOM 등록/수정 폼 |
| `src/components/BOMBulkForm.tsx` | BOM 일괄 등록 폼 |
| `src/app/master/bom/page.tsx` | BOM 관리 페이지 |

### 6.2 연관 컴포넌트

| 파일 | 역할 |
|------|------|
| `src/components/bom/BOMTreeView.tsx` | BOM 계층 트리 뷰 |
| `src/components/bom/BOMViewer.tsx` | BOM 조회/전개 뷰어 |
| `src/hooks/useBOM.ts` | BOM React Query 훅 |

---

## 7. 변경 이력

| 날짜 | 변경 내용 | 담당자 |
|------|----------|--------|
| 2025-11-30 | 중복 입력 허용 정책 적용 | - |
| 2025-11-30 | 순환 참조 검사 비활성화 | - |
| 2025-11-30 | 본 문서 최초 작성 | - |
