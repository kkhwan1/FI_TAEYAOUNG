# BOM 사용 방법 종합 가이드

**최종 업데이트**: 2025-11-27  
**시스템**: 태창금속 ERP

---

## 목차

1. [BOM 시스템 개요](#1-bom-시스템-개요)
2. [품목 등록 시 필수 설정 가이드](#2-품목-등록-시-필수-설정-가이드)
3. [단계별 사용 방법](#3-단계별-사용-방법)
4. [생산 시 자동 재고 차감](#4-생산-시-자동-재고-차감)
5. [재고 부족 처리](#5-재고-부족-처리)
6. [공정관리 시스템](#6-공정관리-시스템)
7. [실제 사용 예시](#7-실제-사용-예시)
8. [주의사항 및 팁](#8-주의사항-및-팁)
9. [시스템 아키텍처](#9-시스템-아키텍처)
10. [FAQ](#10-faq)
11. [실제 코드 예시](#12-실제-코드-예시)
12. [UI 화면별 상세 설명](#13-ui-화면별-상세-설명)
13. [단계별 상세 시나리오](#14-단계별-상세-시나리오)
14. [트러블슈팅](#15-트러블슈팅)
15. [고급 기능](#16-고급-기능)
16. [관련 문서](#14-관련-문서)

---

## 1. BOM 시스템 개요

### 1.1 BOM이란?

**BOM (Bill of Materials, 자재 명세서)**은 완제품을 만들기 위해 필요한 원자재와 부품의 목록과 수량을 정의한 것입니다.

### 1.2 시스템 구조

```
품목 관리 (Items)
    ↓
BOM 관리 (BOM)
    ↓
생산 거래 (Production)
    ↓
자동 재고 차감 (Auto Deduction)
```

### 1.3 핵심 기능

- ✅ **자동 재고 차감**: 생산입고 시 BOM에 따라 원자재 재고 자동 차감
- ✅ **재고 부족 검증**: 생산 전 재고 부족 여부 실시간 확인
- ✅ **이중 검증**: API 레벨 + Database Trigger 레벨 검증
- ✅ **차감 로그**: 모든 재고 차감 내역 자동 기록

---

## 2. 품목 등록 시 필수 설정 가이드

### 2.0 품목 분류 및 타입 설정 규칙

품목 등록 시 BOM 사용을 위해 올바른 분류 설정이 중요합니다.

#### 2.0.1 품목 분류 (Category) - 필수 ⭐

**위치**: 기본 정보 섹션 → 품목 분류 드롭다운

**옵션**:
- `원자재`: 생산에 사용되는 원자재 (BOM의 자품목)
- `부자재`: 생산에 사용되는 부자재 (BOM의 자품목)
- `반제품`: 제조 과정 중인 부분품
- `제품` 또는 `완제품`: 최종 완성된 제품 (BOM의 모품목) ⭐
- `상품`: 판매용 상품

**BOM 사용 규칙**:
- ✅ **모품목**: 반드시 `제품` 또는 `완제품` 선택
- ✅ **자품목**: `원자재` 또는 `부자재` 선택

#### 2.0.2 품목 타입 (Item Type) - 선택

**위치**: 기본 정보 섹션 → 품목 타입 드롭다운

**옵션**:
- `원자재 (RAW)`: 원자재 타입
- `부자재 (SUB)`: 부자재 타입
- `완제품 (FINISHED)`: 완제품 타입

**권장 설정**:
- 모품목: `완제품 (FINISHED)`
- 자품목: `원자재 (RAW)` 또는 `부자재 (SUB)`

#### 2.0.3 소재 형태 (Material Type) - 선택

**위치**: 기본 정보 섹션 → 소재 형태 드롭다운

**옵션**:
- `COIL`: 코일 형태 원자재
- `SHEET`: 판재 형태 원자재
- `기타 (OTHER)`: 기타 형태

**용도**: 원자재의 물리적 형태를 구분합니다.

#### 2.0.4 재고 분류 (Inventory Type) - 선택

**위치**: 재고 및 단가 섹션 → 재고 분류 드롭다운

**옵션**:
- `완제품`: 최종 완성된 제품
- `반제품`: 제조 과정 중인 부분품
- `고객재고`: 고객 위탁 보관 재고
- `원재료`: 생산에 사용되는 원자재
- `코일`: 코일 형태 원자재 ⭐

**BOM 사용 규칙**:
- 코일 형태 원자재는 **재고 분류 = '코일'**로 설정
- BOM 관리 화면에서 "코일만 보기" 필터 사용 시 `코일`로 분류된 자품목만 표시됩니다.

#### 2.0.5 품질 상태 (Quality Status) - 선택

**위치**: 재고 및 단가 섹션 → 품질 상태 드롭다운

**옵션**:
- `검수중`: 검수 진행 중
- `합격`: 검수 합격
- `불합격`: 검수 불합격
- `보류`: 검수 보류

**용도**: 재고의 품질 상태를 관리합니다.

#### 2.0.6 설정 요약표

| 품목 종류 | 품목 분류 | 품목 타입 | 재고 분류 | 용도 |
|---------|---------|---------|---------|------|
| **모품목** | `제품` 또는 `완제품` | `완제품 (FINISHED)` | `완제품` | BOM의 부모 품목 |
| **자품목 (일반)** | `원자재` 또는 `부자재` | `원자재 (RAW)` 또는 `부자재 (SUB)` | `원재료` | BOM의 자식 품목 |
| **자품목 (코일)** | `원자재` | `원자재 (RAW)` | `코일` ⭐ | 코일 필터링 가능 |

---

## 3. 단계별 사용 방법

### 3.1 단계 1: 품목 관리에서 품목 등록

**경로**: `/master/items`

#### 2.1.1 완제품(모품목) 등록

1. **품목 추가** 버튼 클릭
2. **기본 정보** 섹션 입력:
   - **품목 코드** (필수): 제품 고유 번호 (예: `CAR-001`)
   - **품목명** (필수): 제품 이름 (예: `자동차 부품 A`)
   - **품목 분류** (필수): `제품` 또는 `완제품` 선택 ⭐ **중요**
   - **품목 타입**: `완제품 (FINISHED)` 선택
   - **소재 형태**: `기타 (OTHER)` 또는 해당 형태 선택
   - **단위** (필수): 생산 단위 (예: `EA`, `KG`)

3. **재고 및 단가** 섹션 입력:
   - **현재고**: 초기 재고 수량 (예: `0`)
   - **안전재고**: 최소 보유 재고량 (선택)
   - **기준단가**: 제품 단가 (선택)
   - **재고 분류**: `완제품` 선택 (선택 사항)
   - **품질 상태**: `합격` 등 선택 (선택 사항)

4. **저장** 클릭

> ⚠️ **중요**: BOM의 모품목은 반드시 **품목 분류 = '제품'** 또는 **'완제품'**으로 설정해야 합니다.

#### 2.1.2 원자재(자품목) 등록

1. 동일하게 품목 추가
2. **기본 정보** 섹션 입력:
   - **품목 코드** (필수): 원자재 고유 번호 (예: `STEEL-001`)
   - **품목명** (필수): 원자재 이름 (예: `철판 2mm`)
   - **품목 분류** (필수): `원자재` 선택 ⭐ **중요**
   - **품목 타입**: `원자재 (RAW)` 선택
   - **소재 형태**: 
     - 코일 형태: `COIL` 선택
     - 판재 형태: `SHEET` 선택
     - 기타: `기타 (OTHER)` 선택
   - **단위** (필수): 원자재 단위 (예: `KG`, `EA`)

3. **재고 및 단가** 섹션 입력:
   - **현재고**: 보유 재고 수량 (예: `1000`)
   - **안전재고**: 최소 보유 재고량 (선택)
   - **기준단가**: 원자재 단가 (선택)
   - **재고 분류**: 
     - 일반 원자재: `원재료` 선택
     - 코일 형태: `코일` 선택 ⭐ **코일 필터링 시 필요**
   - **품질 상태**: `합격` 등 선택 (선택 사항)

4. **저장** 클릭

> 💡 **팁**: 
> - 원자재는 생산 전에 충분한 재고를 확보해야 합니다.
> - 코일 형태 원자재는 **재고 분류 = '코일'**로 설정하면 BOM에서 코일만 필터링할 수 있습니다.
> - 부자재도 동일하게 등록하되, **품목 분류 = '부자재'**로 설정합니다.

---

### 3.2 단계 2: BOM 관리에서 관계 설정

**경로**: `/master/bom`

#### 2.2.1 BOM 추가

1. **BOM 추가** 버튼 클릭
2. **모품목 선택**: 완제품 선택 (예: `ABC-123 - 자동차 부품 A`)
3. **자품목 선택**: 원자재 선택 (예: `RAW-001 - 철판 2mm`)
4. **소요량 입력**: 완제품 1개당 필요한 원자재 수량
   - 예: 완제품 1개 = 철판 2.5KG → `2.5` 입력
5. **레벨 번호**: BOM 계층 구조 (기본값: 1)
6. **비고**: 추가 설명 (선택)
7. **저장** 클릭

#### 2.2.2 다중 자품목 추가

하나의 완제품에 여러 원자재가 필요한 경우:

1. 첫 번째 자품목 추가 후
2. 동일한 모품목으로 **BOM 추가** 다시 클릭
3. 다른 자품목 선택 및 소요량 입력
4. 반복하여 모든 원자재 등록

**예시**:
```
완제품: ABC-123 (자동차 부품 A)
├─ 자품목 1: RAW-001 (철판 2mm) - 소요량: 2.5 KG
├─ 자품목 2: RAW-002 (볼트 M8) - 소요량: 4 EA
└─ 자품목 3: RAW-003 (용접봉) - 소요량: 0.5 KG
```

#### 2.2.3 BOM 확인

- BOM 목록에서 모품목별로 그룹화되어 표시
- 각 BOM 항목의 소요량, 레벨, 상태 확인 가능
- BOM 미리보기 기능으로 전체 구조 확인

---

### 3.3 단계 3: 생산 거래 등록

**경로**: `/inventory` → **생산** 탭

#### 2.3.1 생산입고 등록

1. **생산입고 추가** 버튼 클릭
2. 필수 정보 입력:
   - **거래일자**: 생산일자
   - **제품 선택**: 완제품 선택 (BOM이 등록된 제품)
   - **생산수량**: 생산할 수량 (예: `100 EA`)
   - **단가**: 제품 단가
   - **참조번호**: 작업지시서 번호 등 (선택)
   - **비고**: 추가 설명 (선택)

3. **BOM 사용** 체크박스 확인 (기본값: 체크됨)

#### 2.3.2 실시간 BOM 검증

생산수량을 입력하면 **자동으로 BOM 검증**이 실행됩니다:

- ✅ **재고 충분**: 모든 원자재 재고가 충분한 경우
- ⚠️ **재고 부족**: 일부 원자재 재고가 부족한 경우
  - 부족한 원자재 목록 표시
  - 최대 생산 가능 수량 표시
  - 부족 수량 표시

#### 2.3.3 생산 등록 완료

1. **저장** 버튼 클릭
2. 시스템이 자동으로:
   - ✅ 완제품 재고 **증가** (생산입고)
   - ✅ 원자재 재고 **자동 차감** (BOM 기준)
   - ✅ 차감 로그 자동 기록

---

## 4. 생산 시 자동 재고 차감

### 3.1 자동 차감 프로세스

```
생산입고 등록
    ↓
BOM 조회 (모품목의 모든 자품목)
    ↓
필요 수량 계산 (소요량 × 생산수량)
    ↓
재고 검증 (현재 재고 ≥ 필요 수량)
    ↓
자동 재고 차감
    ↓
차감 로그 기록
```

### 3.2 차감 계산 공식

```
필요 수량 = BOM 소요량 × 생산 수량

예시:
- 완제품: ABC-123
- 생산 수량: 100 EA
- BOM: 철판 2.5 KG/EA
- 필요 수량: 2.5 × 100 = 250 KG
- 현재 재고: 300 KG
- 차감 후 재고: 300 - 250 = 50 KG
```

### 3.3 다중 자품목 차감

여러 원자재가 있는 경우, **모든 원자재가 동시에 차감**됩니다:

```
생산 수량: 100 EA

자품목 1: 철판 2mm
- 소요량: 2.5 KG/EA
- 필요 수량: 250 KG
- 차감: 250 KG

자품목 2: 볼트 M8
- 소요량: 4 EA/EA
- 필요 수량: 400 EA
- 차감: 400 EA

자품목 3: 용접봉
- 소요량: 0.5 KG/EA
- 필요 수량: 50 KG
- 차감: 50 KG
```

### 3.4 차감 로그 확인

생산 등록 후 **자동 차감 내역**이 표시됩니다:

- 차감된 원자재 목록
- 차감 전/후 재고
- 사용률 (usage_rate)
- 차감 수량

---

## 5. 재고 부족 처리

### 4.1 재고 부족 시나리오

#### 시나리오 1: 일부 원자재 부족

```
생산 수량: 100 EA

자품목 1: 철판 2mm
- 필요: 250 KG
- 보유: 200 KG
- 부족: 50 KG ⚠️

자품목 2: 볼트 M8
- 필요: 400 EA
- 보유: 500 EA
- 충분: ✅
```

**처리 방법**:
1. ⚠️ 경고 메시지 표시
2. 최대 생산 가능 수량 제안 (80 EA)
3. 사용자 선택:
   - **부족한 상태로 생산 진행** (가능)
   - **수량 조정 후 생산**
   - **원자재 입고 후 생산**

#### 시나리오 2: 모든 원자재 부족

```
생산 수량: 100 EA

자품목 1: 철판 2mm
- 필요: 250 KG
- 보유: 50 KG
- 부족: 200 KG ⚠️

자품목 2: 볼트 M8
- 필요: 400 EA
- 보유: 100 EA
- 부족: 300 EA ⚠️
```

**처리 방법**:
1. ⚠️ 경고 메시지 표시
2. 최대 생산 가능 수량 계산 (20 EA)
3. 부족 원자재 목록 표시
4. 사용자 선택:
   - **수량 조정** (20 EA로 생산)
   - **원자재 입고 후 생산**

### 4.2 재고 부족 시 차감 동작

시스템은 **재고 부족 시에도 생산을 차단하지 않습니다**:

- ⚠️ **경고만 표시**: 재고 부족 경고 메시지
- ✅ **가능한 만큼 차감**: 보유 재고만큼만 차감
- 📝 **부족 수량 기록**: `bom_deduction_log`에 부족 수량 기록
- 🔍 **이후 추적 가능**: 생산 이력에서 부족 수량 확인 가능

### 4.3 재고 부족 확인 방법

**생산 이력 조회** (`/inventory` → 생산 탭):

- 각 생산 거래의 **부족 총 수량** 표시
- 부족 원자재 상세 내역 확인
- 부족 수량 단위 표시

---

## 6. 공정관리 시스템

### 6.1 공정관리란?

**공정관리**는 제조 과정의 각 단계를 추적하고 관리하는 시스템입니다. BOM과 함께 사용하여 생산 프로세스를 세밀하게 관리할 수 있습니다.

#### 6.1.1 BOM vs 공정관리

| 구분 | BOM | 공정관리 |
|------|-----|---------|
| **목적** | 완제품 생산에 필요한 원자재 목록 | 제조 과정의 각 단계 관리 |
| **관계** | 모품목 → 자품목 (정적) | 투입재료 → 산출제품 (동적) |
| **재고 차감** | 생산입고 시 자동 차감 | 공정 완료 시 자동 이동 |
| **사용 시점** | 생산 계획 수립 시 | 실제 제조 작업 시 |

#### 6.1.2 공정 유형

**경로**: `/process`

**공정 유형**:
- **BLANKING (블랭킹 공정)**: 코일 → 판지 변환
  - 투입: 코일 형태 원자재
  - 산출: 판지 형태 반제품
- **PRESS (Press 공정)**: 판지 → 완제품 변환
  - 투입: 판지 형태 반제품
  - 산출: 완제품
- **ASSEMBLY (조립 공정)**: 부품 조립
  - 투입: 여러 부품
  - 산출: 조립된 제품

#### 6.1.3 공정 상태

- **PENDING (대기)**: 공정 작업이 등록만 된 상태
- **IN_PROGRESS (진행중)**: 작업이 시작된 상태
- **COMPLETED (완료)**: 작업이 완료된 상태 → **재고 자동 이동**
- **CANCELLED (취소)**: 작업이 취소된 상태

### 6.2 공정 작업 등록

#### 6.2.1 기본 등록 방법

1. **공정관리** 페이지 (`/process`) 접속
2. **공정 추가** 버튼 클릭
3. **공정 정보 입력**:
   - **공정유형** (필수): BLANKING, PRESS, ASSEMBLY 중 선택
   - **투입재료** (필수): 원자재 또는 반제품 선택
   - **산출제품** (필수): 반제품 또는 완제품 선택
   - **투입수량** (필수): 사용할 원자재 수량
   - **산출수량** (필수): 생산될 제품 수량
   - **작업자**: 작업자 ID 또는 이름 (선택)
   - **비고**: 추가 설명 (선택)

4. **저장** 클릭

#### 6.2.2 자동 계산 기능

**과거 평균 수율 기반 산출수량 제안**:
- 투입수량 입력 시, 과거 동일 공정의 평균 수율을 기반으로 산출수량 자동 계산
- 제안값이 표시되면 **"적용"** 버튼으로 자동 입력 가능

**코일 스펙 기반 투입수량 제안** (BLANKING 공정):
- 코일 형태 원자재 선택 시, 코일 스펙(`weight_per_piece`)을 기반으로 투입수량 자동 계산
- 현재 재고를 고려하여 최대 투입 가능 수량 제안

**수율 자동 계산**:
- 투입수량과 산출수량 입력 시 자동으로 수율 계산
- 수율 = (산출수량 / 투입수량) × 100

#### 6.2.3 간편 등록 모드

**간편 등록 모드**를 사용하면 공정 작업을 등록하고 **즉시 완료 처리**하여 재고가 자동으로 이동됩니다.

**사용 방법**:
1. 공정 정보 입력
2. **"간편 등록 모드"** 체크박스 선택
3. **"간편 등록 (재고 자동 이동)"** 버튼 클릭

**동작**:
- 공정 작업이 `COMPLETED` 상태로 즉시 생성
- 투입재료 재고 **자동 차감**
- 산출제품 재고 **자동 증가**
- LOT 번호 자동 생성
- 수율 자동 계산

**장점**:
- 빠른 공정 처리
- 재고 즉시 반영
- 별도의 완료 처리 불필요

### 6.3 공정 작업 진행

#### 6.3.1 작업 시작

**대기(PENDING) 상태**에서 작업을 시작할 수 있습니다:

1. 공정 목록에서 해당 작업 선택
2. **"작업 시작"** 버튼 클릭
3. 상태가 `IN_PROGRESS`로 변경
4. `started_at` 시간 기록

#### 6.3.2 작업 완료

**진행중(IN_PROGRESS) 상태**에서 작업을 완료할 수 있습니다:

1. 공정 목록에서 해당 작업 선택
2. **"작업 완료"** 버튼 클릭
3. 상태가 `COMPLETED`로 변경
4. `completed_at` 시간 기록
5. **재고 자동 이동** (Database Trigger)

**재고 이동 내역**:
- 투입재료: `current_stock` 감소 (투입수량만큼)
- 산출제품: `current_stock` 증가 (산출수량만큼)
- `inventory_transactions` 테이블에 거래 기록

### 6.4 공정과 BOM의 관계

#### 6.4.1 공정은 BOM의 일부 단계

공정관리는 BOM의 각 단계를 세밀하게 관리합니다:

```
BOM 구조:
완제품 (CAR-001)
├─ 자품목 1: 철판 2mm (STEEL-001) - 소요량: 2.5 KG
├─ 자품목 2: 볼트 M8 (BOLT-001) - 소요량: 4 EA
└─ 자품목 3: 용접봉 (WELD-001) - 소요량: 0.5 KG

공정 프로세스:
1. BLANKING 공정: 코일 (COIL-001) → 판지 (STEEL-001)
2. PRESS 공정: 판지 (STEEL-001) + 볼트 (BOLT-001) → 반제품
3. ASSEMBLY 공정: 반제품 + 용접봉 (WELD-001) → 완제품 (CAR-001)
```

#### 6.4.2 공정 완료 후 생산 등록

공정을 통해 반제품을 만들고, 최종적으로 생산입고를 등록할 때 BOM을 사용합니다:

**프로세스**:
1. **공정 1 (BLANKING)**: 코일 → 판지
   - 코일 재고 감소
   - 판지 재고 증가

2. **공정 2 (PRESS)**: 판지 → 반제품
   - 판지 재고 감소
   - 반제품 재고 증가

3. **생산입고 등록** (`/inventory` → 생산):
   - 완제품 선택
   - BOM에 따라 원자재 자동 차감
   - 완제품 재고 증가

### 6.5 공정 작업 관리

#### 6.5.1 공정 목록 조회

**필터 옵션**:
- **상태별 탭**: 대기, 진행중, 완료, 전체
- **공정 유형**: BLANKING, PRESS, ASSEMBLY
- **날짜 범위**: 시작일 ~ 종료일
- **검색**: 품목명, 품목코드, 비고

#### 6.5.2 공정 통계

- 총 공정 수
- 상태별 개수 (대기, 진행중, 완료, 취소)
- 평균 수율
- 일일 생산량

#### 6.5.3 LOT 추적

각 공정 작업은 **LOT 번호**가 자동 생성됩니다:

- **형식**: `BLK-YYYYMMDD-001` (공정유형-날짜-순번)
- **용도**: 생산 이력 추적
- **연계**: 부모 LOT, 자식 LOT 추적 가능

### 6.6 공정 완료 시 재고 이동

#### 6.6.1 자동 재고 이동 프로세스

```
공정 작업 완료 (COMPLETED)
    ↓
Database Trigger 실행
    ↓
투입재료 재고 차감 (생산출고)
    ↓
산출제품 재고 증가 (생산입고)
    ↓
inventory_transactions 기록
    ↓
재고 업데이트 완료
```

#### 6.6.2 재고 이동 내역 확인

공정 완료 후 재고 이동 내역을 확인할 수 있습니다:

- `/inventory` → 재고 거래 탭
- 거래유형: `생산입고`, `생산출고`
- 참조: `process_operation` + 작업 ID

### 6.7 공정관리 사용 예시

#### 예시: BLANKING 공정

**1단계: 공정 등록**
```
공정유형: BLANKING
투입재료: COIL-001 (코일 2mm)
산출제품: STEEL-001 (판지 2mm)
투입수량: 1000 KG
산출수량: 950 KG (수율 95%)
```

**2단계: 작업 시작**
- 상태: PENDING → IN_PROGRESS
- 시작 시간 기록

**3단계: 작업 완료**
- 상태: IN_PROGRESS → COMPLETED
- 완료 시간 기록
- **재고 자동 이동**:
  - COIL-001: 1000 KG 감소
  - STEEL-001: 950 KG 증가

**4단계: 결과 확인**
- LOT 번호: `BLK-20251127-001`
- 수율: 95%
- 재고 변화 확인

#### 예시: 간편 등록 모드

**1단계: 공정 정보 입력**
```
공정유형: PRESS
투입재료: STEEL-001 (판지 2mm)
산출제품: CAR-001 (자동차 부품 A)
투입수량: 100 EA
산출수량: 95 EA
```

**2단계: 간편 등록**
- "간편 등록 모드" 체크
- "간편 등록" 버튼 클릭

**3단계: 즉시 완료**
- 상태: COMPLETED (즉시)
- 재고 자동 이동 완료
- LOT 번호 자동 생성

---

## 7. 완전한 제조 프로세스 예시

### 7.0 전체 프로세스 개요

완제품 생산부터 원자재까지의 전체 프로세스를 하나의 예시로 설명합니다.

**시나리오**: 자동차 부품 A (완제품) 생산

**전체 흐름**:
```
1. 품목 등록 (완제품, 반제품, 원자재)
   ↓
2. BOM 설정 (완제품 → 원자재 관계)
   ↓
3. 원자재 입고
   ↓
4. 공정 작업 (BLANKING: 코일 → 판지)
   ↓
5. 공정 작업 (PRESS: 판지 → 반제품)
   ↓
6. 생산입고 등록 (BOM 기반 자동 차감)
   ↓
7. 재고 확인 및 이력 추적
```

---

### 7.1 단계 1: 품목 등록 (완제품 → 원자재)

#### 7.1.1 완제품 등록 (모품목)

**경로**: `/master/items` → **품목 추가**

**기본 정보** 섹션:
```
품목 코드: CAR-001
품목명: 자동차 부품 A
품목 분류: 제품 ⭐ (필수 - BOM 모품목)
품목 타입: 완제품 (FINISHED)
소재 형태: 기타 (OTHER)
차종: EV6
규격/사양: 0.8T x 1200
단위: EA
```

**재고 및 단가** 섹션:
```
현재고: 0
안전재고: 10
기준단가: 50000
재고 분류: 완제품 (선택)
품질 상태: 합격 (선택)
```

**저장** 클릭 → 완제품 등록 완료

#### 7.1.2 반제품 등록 (중간 단계)

**기본 정보** 섹션:
```
품목 코드: SEMI-001
품목명: 프레스 판지 (자동차 부품 A용)
품목 분류: 반제품 ⭐
품목 타입: 원자재 (RAW) 또는 부자재 (SUB)
소재 형태: SHEET
단위: EA
```

**재고 및 단가** 섹션:
```
현재고: 0
안전재고: 20
기준단가: 30000
재고 분류: 반제품 (선택)
```

**저장** 클릭 → 반제품 등록 완료

#### 7.1.3 원자재 등록 (자품목)

**원자재 1: 코일**
```
기본 정보:
- 품목 코드: COIL-001
- 품목명: 코일 2mm (SPHC)
- 품목 분류: 원자재 ⭐ (필수 - BOM 자품목)
- 품목 타입: 원자재 (RAW)
- 소재 형태: COIL ⭐
- 소재/강종: SPHC
- 단위: KG

재고 및 단가:
- 현재고: 0
- 안전재고: 500
- 기준단가: 5000
- 재고 분류: 코일 ⭐ (코일 필터링 시 필수)
```

**원자재 2: 볼트**
```
기본 정보:
- 품목 코드: BOLT-001
- 품목명: 볼트 M8 x 20
- 품목 분류: 원자재 ⭐
- 품목 타입: 원자재 (RAW)
- 소재 형태: 기타 (OTHER)
- 단위: EA

재고 및 단가:
- 현재고: 0
- 안전재고: 1000
- 기준단가: 100
- 재고 분류: 원재료
```

**원자재 3: 용접봉**
```
기본 정보:
- 품목 코드: WELD-001
- 품목명: 용접봉 3.2mm
- 품목 분류: 원자재 ⭐
- 품목 타입: 원자재 (RAW)
- 소재 형태: 기타 (OTHER)
- 단위: KG

재고 및 단가:
- 현재고: 0
- 안전재고: 50
- 기준단가: 8000
- 재고 분류: 원재료
```

**저장** 클릭 → 모든 원자재 등록 완료

---

### 7.2 단계 2: 원자재 입고

**경로**: `/inventory` → **입고** 탭 → **입고 추가**

#### 7.2.1 코일 입고

```
거래일자: 2025-11-27
품목: COIL-001 (코일 2mm)
수량: 5000 KG
단가: 5000 원/KG
거래처: 철강공급사
참조번호: PO-20251127-001
```

**저장** → 코일 재고: 0 → 5000 KG

#### 7.2.2 볼트 입고

```
거래일자: 2025-11-27
품목: BOLT-001 (볼트 M8)
수량: 10000 EA
단가: 100 원/EA
거래처: 볼트공급사
참조번호: PO-20251127-002
```

**저장** → 볼트 재고: 0 → 10000 EA

#### 7.2.3 용접봉 입고

```
거래일자: 2025-11-27
품목: WELD-001 (용접봉)
수량: 500 KG
단가: 8000 원/KG
거래처: 용접재료공급사
참조번호: PO-20251127-003
```

**저장** → 용접봉 재고: 0 → 500 KG

**현재 재고 상태**:
- COIL-001: 5000 KG ✅
- BOLT-001: 10000 EA ✅
- WELD-001: 500 KG ✅

---

### 7.3 단계 3: 공정 작업 (BLANKING)

**경로**: `/process` → **공정 추가**

#### 7.3.1 BLANKING 공정 등록

**공정 정보 입력**:
```
공정유형: BLANKING
투입재료: COIL-001 (코일 2mm)
산출제품: SEMI-001 (프레스 판지)
투입수량: 1000 KG
산출수량: 950 EA (수율 95%)
작업자: 김작업
비고: 1차 블랭킹 작업
```

**자동 계산 기능**:
- 코일 스펙 기반 투입수량 제안: 1000 EA (코일 스펙 `weight_per_piece` 기반)
- 과거 평균 수율 기반 산출수량 제안: 950 EA (평균 수율 95% 기반)

**간편 등록 모드** 체크 → **"간편 등록 (재고 자동 이동)"** 클릭

#### 7.3.2 공정 완료 결과

**자동 처리 내역**:
```
✅ 공정 작업 생성: operation_id = 1
✅ 상태: COMPLETED (즉시 완료)
✅ LOT 번호: BLK-20251127-001
✅ 수율: 95%

재고 자동 이동:
- COIL-001: 5000 → 4000 KG (1000 KG 차감)
- SEMI-001: 0 → 950 EA (950 EA 증가)
```

**재고 거래 자동 생성**:
- `생산출고`: COIL-001, 1000 KG
- `생산입고`: SEMI-001, 950 EA

**현재 재고 상태**:
- COIL-001: 4000 KG
- SEMI-001: 950 EA ✅ (반제품 준비 완료)
- BOLT-001: 10000 EA
- WELD-001: 500 KG

---

### 7.4 단계 4: BOM 설정

**경로**: `/master/bom` → **BOM 추가**

#### 7.4.1 완제품 → 반제품 BOM

**BOM 1 추가**:
```
모품목: CAR-001 (자동차 부품 A)
자품목: SEMI-001 (프레스 판지)
소요량: 1 EA/EA
레벨: 1
비고: 반제품 1개 필요
```

**저장** → BOM 1 등록 완료

#### 7.4.2 완제품 → 원자재 BOM

**BOM 2 추가**:
```
모품목: CAR-001 (자동차 부품 A)
자품목: BOLT-001 (볼트 M8)
소요량: 4 EA/EA
레벨: 1
비고: 볼트 4개 필요
```

**저장** → BOM 2 등록 완료

**BOM 3 추가**:
```
모품목: CAR-001 (자동차 부품 A)
자품목: WELD-001 (용접봉)
소요량: 0.5 KG/EA
레벨: 1
비고: 용접봉 0.5KG 필요
```

**저장** → BOM 3 등록 완료

**BOM 구조 확인**:
```
완제품: CAR-001 (자동차 부품 A)
├─ 자품목 1: SEMI-001 (프레스 판지) - 소요량: 1 EA/EA
├─ 자품목 2: BOLT-001 (볼트 M8) - 소요량: 4 EA/EA
└─ 자품목 3: WELD-001 (용접봉) - 소요량: 0.5 KG/EA
```

---

### 7.5 단계 5: 생산입고 등록 (BOM 기반)

**경로**: `/inventory` → **생산** 탭 → **생산입고 추가**

#### 7.5.1 생산 정보 입력

**기본 정보**:
```
생산일자: 2025-11-27
생산오더 번호: PRD-20251127001
제품 선택: CAR-001 (자동차 부품 A)
생산수량: 100 EA
단가: 50000 원/EA
BOM 사용: ✅ 체크 (기본값)
```

#### 7.5.2 실시간 BOM 검증

생산수량 `100` 입력 시 **자동으로 BOM 검증** 실행:

**BOM 미리보기 표시**:
```
요약:
- 총 자재 수: 3
- 충족 품목: 3 ✅
- 부족 품목: 0
- 희망 생산수량: 100 EA
- 최대 생산가능: 100 EA ✅

자재 상세:
1. SEMI-001 (프레스 판지)
   - 소요량: 1 EA/EA
   - 필요수량: 100 EA
   - 현재재고: 950 EA ✅
   - 부족량: 0 EA
   - 상태: ✅ 충분

2. BOLT-001 (볼트 M8)
   - 소요량: 4 EA/EA
   - 필요수량: 400 EA
   - 현재재고: 10000 EA ✅
   - 부족량: 0 EA
   - 상태: ✅ 충분

3. WELD-001 (용접봉)
   - 소요량: 0.5 KG/EA
   - 필요수량: 50 KG
   - 현재재고: 500 KG ✅
   - 부족량: 0 KG
   - 상태: ✅ 충분
```

**모든 자재 충분** → 생산 가능 ✅

#### 7.5.3 생산 등록 완료

**"생산 등록"** 버튼 클릭

**자동 처리 내역**:
```
✅ 생산입고 거래 생성: transaction_id = 1
✅ 완제품 재고 증가: CAR-001, 0 → 100 EA

BOM 기반 자동 차감:
✅ SEMI-001: 950 → 850 EA (100 EA 차감)
✅ BOLT-001: 10000 → 9600 EA (400 EA 차감)
✅ WELD-001: 500 → 450 KG (50 KG 차감)

차감 로그 기록:
- bom_deduction_log에 모든 차감 내역 기록
```

**생산 결과 모달**:
```
생산 결과:
- 거래번호: TXN-20251127001
- 생산수량: 100 EA
- 제품재고 변화: +100 EA

자재 자동 차감 내역:
1. SEMI-001 (프레스 판지)
   - 차감수량: -100 EA
   - 차감 전: 950 EA
   - 차감 후: 850 EA

2. BOLT-001 (볼트 M8)
   - 차감수량: -400 EA
   - 차감 전: 10000 EA
   - 차감 후: 9600 EA

3. WELD-001 (용접봉)
   - 차감수량: -50 KG
   - 차감 전: 500 KG
   - 차감 후: 450 KG
```

---

### 7.6 단계 6: 최종 재고 확인

**경로**: `/stock` 또는 `/master/items`

#### 7.6.1 최종 재고 상태

**완제품**:
```
CAR-001 (자동차 부품 A)
- 이전 재고: 0 EA
- 생산입고: +100 EA
- 현재 재고: 100 EA ✅
```

**반제품**:
```
SEMI-001 (프레스 판지)
- 이전 재고: 0 EA
- BLANKING 공정: +950 EA
- 생산 차감: -100 EA
- 현재 재고: 850 EA ✅
```

**원자재**:
```
COIL-001 (코일 2mm)
- 입고: +5000 KG
- BLANKING 공정: -1000 KG
- 현재 재고: 4000 KG ✅

BOLT-001 (볼트 M8)
- 입고: +10000 EA
- 생산 차감: -400 EA
- 현재 재고: 9600 EA ✅

WELD-001 (용접봉)
- 입고: +500 KG
- 생산 차감: -50 KG
- 현재 재고: 450 KG ✅
```

#### 7.6.2 재고 이력 추적

**재고 거래 이력** (`/inventory`):

1. **입고 거래** (3건):
   - COIL-001: +5000 KG
   - BOLT-001: +10000 EA
   - WELD-001: +500 KG

2. **생산출고 거래** (공정):
   - COIL-001: -1000 KG (BLANKING 공정)

3. **생산입고 거래** (공정):
   - SEMI-001: +950 EA (BLANKING 공정)

4. **생산입고 거래** (BOM):
   - CAR-001: +100 EA (생산입고)

5. **생산출고 거래** (BOM 자동 차감):
   - SEMI-001: -100 EA
   - BOLT-001: -400 EA
   - WELD-001: -50 KG

---

### 7.7 전체 프로세스 요약

#### 7.7.1 프로세스 흐름도

```
[1단계: 품목 등록]
완제품 (CAR-001) 등록
반제품 (SEMI-001) 등록
원자재 (COIL-001, BOLT-001, WELD-001) 등록
    ↓
[2단계: 원자재 입고]
COIL-001: 0 → 5000 KG
BOLT-001: 0 → 10000 EA
WELD-001: 0 → 500 KG
    ↓
[3단계: 공정 작업 - BLANKING]
COIL-001: 5000 → 4000 KG (-1000 KG)
SEMI-001: 0 → 950 EA (+950 EA)
    ↓
[4단계: BOM 설정]
CAR-001 → SEMI-001 (1 EA/EA)
CAR-001 → BOLT-001 (4 EA/EA)
CAR-001 → WELD-001 (0.5 KG/EA)
    ↓
[5단계: 생산입고 등록]
CAR-001: 0 → 100 EA (+100 EA)
    ↓
[6단계: BOM 자동 차감]
SEMI-001: 950 → 850 EA (-100 EA)
BOLT-001: 10000 → 9600 EA (-400 EA)
WELD-001: 500 → 450 KG (-50 KG)
    ↓
[7단계: 최종 재고]
완제품: 100 EA ✅
반제품: 850 EA ✅
원자재: 코일 4000 KG, 볼트 9600 EA, 용접봉 450 KG ✅
```

#### 7.7.2 재고 변화 상세

| 품목 | 초기 재고 | 입고 | 공정 | 생산 차감 | 최종 재고 |
|------|---------|------|------|----------|---------|
| **CAR-001** (완제품) | 0 | - | - | +100 | **100 EA** ✅ |
| **SEMI-001** (반제품) | 0 | - | +950 | -100 | **850 EA** ✅ |
| **COIL-001** (코일) | 0 | +5000 | -1000 | - | **4000 KG** ✅ |
| **BOLT-001** (볼트) | 0 | +10000 | - | -400 | **9600 EA** ✅ |
| **WELD-001** (용접봉) | 0 | +500 | - | -50 | **450 KG** ✅ |

#### 7.7.3 비용 계산

**생산 비용**:
```
원자재 비용:
- SEMI-001: 100 EA × 30000 원 = 3,000,000 원
- BOLT-001: 400 EA × 100 원 = 40,000 원
- WELD-001: 50 KG × 8000 원 = 400,000 원
총 원자재 비용: 3,440,000 원

완제품 가치:
- CAR-001: 100 EA × 50000 원 = 5,000,000 원

이익: 5,000,000 - 3,440,000 = 1,560,000 원
```

---

### 7.8 추가 시나리오: 재고 부족 상황

#### 시나리오: 반제품 부족

**상황**: BLANKING 공정을 더 많이 진행하지 않아 반제품이 부족한 경우

**생산 계획**: 200 EA 생산

**BOM 미리보기**:
```
⚠️ 경고: 재고 부족
- SEMI-001: 필요 200 EA, 보유 850 EA → 충분 ✅
- BOLT-001: 필요 800 EA, 보유 9600 EA → 충분 ✅
- WELD-001: 필요 100 KG, 보유 450 KG → 충분 ✅

실제로는 모든 자재 충분하지만,
만약 반제품이 50 EA만 있다면:
- 최대 생산가능: 50 EA
- 부족 수량: 150 EA
```

**해결 방법**:
1. **옵션 1**: BLANKING 공정 추가 진행
   - COIL-001로 SEMI-001 추가 생산
   - 반제품 재고 확보 후 생산

2. **옵션 2**: 수량 조정
   - 생산수량을 50 EA로 조정
   - 부족한 만큼만 생산

3. **옵션 3**: 부족 상태로 생산 진행
   - 가능한 만큼만 차감
   - 부족 수량 기록

---

### 7.9 프로세스 체크리스트

#### 생산 전 체크리스트

- [ ] **품목 등록 완료**
  - [ ] 완제품 등록 (품목 분류 = '제품')
  - [ ] 반제품 등록 (품목 분류 = '반제품')
  - [ ] 원자재 등록 (품목 분류 = '원자재')

- [ ] **원자재 입고 완료**
  - [ ] 코일 입고 (BLANKING 공정용)
  - [ ] 볼트 입고
  - [ ] 용접봉 입고

- [ ] **공정 작업 완료**
  - [ ] BLANKING 공정 완료 (코일 → 판지)
  - [ ] 반제품 재고 확인

- [ ] **BOM 설정 완료**
  - [ ] 완제품 → 반제품 BOM 등록
  - [ ] 완제품 → 원자재 BOM 등록
  - [ ] 소요량 정확도 확인

- [ ] **생산 등록 준비**
  - [ ] BOM 미리보기로 재고 확인
  - [ ] 부족 자재 확인 및 입고
  - [ ] 생산수량 결정

#### 생산 후 체크리스트

- [ ] **재고 확인**
  - [ ] 완제품 재고 증가 확인
  - [ ] 원자재 재고 차감 확인
  - [ ] 재고 이력 확인

- [ ] **차감 로그 확인**
  - [ ] bom_deduction_log 확인
  - [ ] 차감 수량 정확도 확인
  - [ ] 부족 수량 확인 (있는 경우)

---

## 8. 실제 사용 예시 (간단 버전)

### 예시 1: 완전한 BOM 설정 및 생산

#### 1단계: 품목 등록

```
✅ 완제품 등록
- 품번: CAR-001
- 품명: 자동차 부품 A
- 카테고리: 제품
- 단위: EA
- 현재 재고: 0

✅ 원자재 등록
- 품번: STEEL-001
- 품명: 철판 2mm
- 카테고리: 원자재
- 단위: KG
- 현재 재고: 1000 KG
```

#### 2단계: BOM 설정

```
✅ BOM 추가
- 모품목: CAR-001 (자동차 부품 A)
- 자품목: STEEL-001 (철판 2mm)
- 소요량: 2.5 KG/EA
```

#### 3단계: 생산 등록

```
✅ 생산입고 등록
- 제품: CAR-001
- 생산수량: 100 EA
- BOM 사용: ✅ 체크

자동 계산:
- 필요 철판: 2.5 × 100 = 250 KG
- 현재 재고: 1000 KG
- 차감 후 재고: 1000 - 250 = 750 KG ✅
```

#### 4단계: 결과 확인

```
✅ 완제품 재고: 0 → 100 EA (증가)
✅ 원자재 재고: 1000 → 750 KG (차감)
✅ 차감 로그 자동 기록
```

### 예시 2: 재고 부족 상황

#### 상황

```
현재 재고:
- 철판 2mm: 200 KG
- 생산 계획: 100 EA
- 필요 수량: 250 KG
- 부족: 50 KG
```

#### 처리

1. **생산입고 등록 시**:
   - ⚠️ 경고: "철판 2mm 재고 부족 (필요: 250 KG, 보유: 200 KG)"
   - 💡 제안: "최대 생산 가능 수량: 80 EA"

2. **사용자 선택**:
   - 옵션 1: 수량을 80 EA로 조정
   - 옵션 2: 100 EA로 진행 (부족 상태로 생산)

3. **100 EA로 진행한 경우**:
   - ✅ 철판 200 KG 차감 (가능한 만큼)
   - ⚠️ 부족 50 KG 기록
   - 📝 차감 로그에 부족 수량 기록

---

## 8. 주의사항 및 팁

### 6.1 주의사항

#### ⚠️ BOM 등록 전 생산 금지

- BOM이 등록되지 않은 제품은 생산 가능하지만, **원자재 자동 차감이 되지 않습니다**
- 생산 전 반드시 BOM을 등록하세요

#### ⚠️ 재고 부족 시 주의

- 재고 부족 상태로 생산하면 **부족 수량이 기록**됩니다
- 생산 이력에서 부족 수량을 확인하고, **추가 원자재 입고**를 진행하세요

#### ⚠️ 소요량 정확도

- BOM 소요량은 **정확하게 입력**해야 합니다
- 소요량 오류 시 재고 차감이 잘못됩니다

### 6.2 유용한 팁

#### 💡 BOM 미리보기 활용

- 생산 전 BOM 미리보기로 필요한 원자재 확인
- 재고 부족 원자재 사전 파악

#### 💡 배치 생산 모드

- 여러 제품을 한 번에 생산 등록 가능
- 각 제품별 BOM 자동 차감

#### 💡 재고 이력 추적

- `/stock` 페이지에서 재고 이력 확인
- BOM 차감으로 인한 재고 변동 추적 가능

#### 💡 생산 이력 확인

- `/inventory` → 생산 탭에서 모든 생산 이력 확인
- 부족 수량, 차감 내역 상세 확인

---

## 9. 시스템 아키텍처

### 7.1 이중 검증 시스템

시스템은 **API 레벨**과 **Database Trigger 레벨**에서 이중으로 검증합니다:

```
생산입고 등록 요청
    ↓
API 레벨 검증
- BOM 조회
- 재고 검증
- 경고 표시
    ↓
Database Trigger
- 자동 재고 차감
- 차감 로그 기록
- 재고 업데이트
```

### 7.2 관련 테이블

- `items`: 품목 정보
- `bom`: BOM 관계 (모품목-자품목)
- `inventory_transactions`: 재고 거래
- `bom_deduction_log`: BOM 차감 로그

---

## 10. FAQ

### Q1: BOM 없이 생산할 수 있나요?

**A**: 가능합니다. 하지만 원자재 자동 차감이 되지 않으므로, 수동으로 원자재 출고를 등록해야 합니다.

### Q2: 재고 부족 시 생산이 차단되나요?

**A**: 아니요. 경고만 표시되고, 가능한 만큼만 차감됩니다. 부족 수량은 로그에 기록됩니다.

### Q3: BOM 수정 후 기존 생산 이력에 영향이 있나요?

**A**: 없습니다. BOM 수정은 이후 생산부터 적용됩니다. 기존 생산 이력은 변경되지 않습니다.

### Q4: 여러 단계의 BOM이 있나요?

**A**: 네, `level_no` 필드로 다단계 BOM을 지원합니다. 현재는 1단계 BOM이 주로 사용됩니다.

### Q5: 생산 취소 시 재고가 복구되나요?

**A**: 생산 거래를 삭제하면 Database Trigger가 자동으로 재고를 복구합니다.

### Q6: 공정관리와 BOM의 차이는 무엇인가요?

**A**: 
- **BOM**: 완제품 생산에 필요한 원자재 목록 (정적 관계)
- **공정관리**: 제조 과정의 각 단계를 추적 (동적 프로세스)
- 공정은 BOM의 일부 단계를 세밀하게 관리합니다.

### Q7: 공정 완료 시 재고가 자동으로 이동하나요?

**A**: 네, 공정 작업을 `COMPLETED` 상태로 변경하면 Database Trigger가 자동으로 재고를 이동시킵니다.

### Q8: 간편 등록 모드와 일반 등록의 차이는?

**A**:
- **일반 등록**: 공정 작업만 등록 (PENDING 상태), 나중에 완료 처리 필요
- **간편 등록**: 공정 등록 + 즉시 완료 처리 (COMPLETED 상태), 재고 즉시 이동

### Q9: 공정 수율이 100%를 초과할 수 있나요?

**A**: 기술적으로는 가능하지만, 일반적으로는 100% 이하입니다. 수율이 100%를 초과하면 입력값을 확인해야 합니다.

---

## 12. 실제 코드 예시

### 9.1 BOM 검증 API 호출

생산 수량을 입력하면 자동으로 BOM 검증이 실행됩니다:

```typescript
// src/app/api/inventory/production/bom-check/route.ts
export async function GET(request: NextRequest) {
  const productItemId = searchParams.get('product_item_id');
  const quantity = parseFloat(searchParams.get('quantity') || '1');

  // BOM 조회
  const { data: bomItems } = await supabase
    .from('bom')
    .select(`
      bom_id,
      parent_item_id,
      child_item_id,
      quantity_required,
      child_item:items!child_item_id (
        item_code,
        item_name,
        current_stock,
        unit
      )
    `)
    .eq('parent_item_id', productItemId)
    .eq('is_active', true);

  // 재고 검증
  for (const bomItem of bomItems) {
    const requiredQuantity = bomItem.quantity_required * quantity;
    const availableStock = bomItem.child_item?.current_stock || 0;
    const shortage = Math.max(0, requiredQuantity - availableStock);
    
    // 부족 여부 확인
    if (availableStock < requiredQuantity) {
      canProduce = false;
      totalShortage += shortage;
    }
  }
}
```

### 9.2 생산 등록 시 자동 차감

```typescript
// src/app/api/inventory/production/route.ts
export async function POST(request: NextRequest) {
  // 생산입고 거래 등록
  const { data: transaction } = await supabase
    .from('inventory_transactions')
    .insert([{
      item_id,
      transaction_type: '생산입고',
      quantity: parsedQuantity,
      // ...
    }])
    .select();

  // Database Trigger가 자동으로:
  // 1. BOM 조회
  // 2. 원자재 재고 차감
  // 3. bom_deduction_log 기록
  // 4. items.current_stock 업데이트
}
```

### 9.3 실시간 BOM 미리보기

```typescript
// src/components/ProductionForm.tsx
useEffect(() => {
  if (selectedProduct && formData.quantity > 0 && formData.use_bom) {
    const productId = selectedProduct.item_id;
    if (productId > 0) {
      // 500ms 디바운스로 API 호출
      debouncedCheckBom(productId, formData.quantity);
    }
  }
}, [selectedProduct, formData.quantity, formData.use_bom]);
```

---

## 13. UI 화면별 상세 설명

### 10.1 품목 관리 화면 (`/master/items`)

#### 화면 구성
- **품목 목록 테이블**: 품번, 품명, 카테고리, 단위, 현재 재고 등
- **품목 추가 버튼**: 우측 상단
- **검색/필터**: 품번, 품명으로 검색

#### 품목 등록 시 입력 필드
1. **품번** (필수): 고유 식별자 (예: `CAR-001`)
2. **품명** (필수): 품목 이름 (예: `자동차 부품 A`)
3. **카테고리** (필수): 
   - `제품`: 완제품 (모품목)
   - `원자재`: 원자재 (자품목)
   - `스크랩`: 스크랩
4. **단위** (필수): `EA`, `KG`, `M` 등
5. **현재 재고**: 초기 재고 수량
6. **안전 재고**: 최소 보유 재고량 (선택)
7. **단가**: 기본 단가 (선택)

### 10.2 BOM 관리 화면 (`/master/bom`)

#### 화면 구성
- **BOM 목록**: 모품목별로 그룹화
- **BOM 추가 버튼**: 새 BOM 관계 등록
- **BOM 미리보기**: 트리 구조로 표시

#### BOM 추가 폼
1. **모품목 선택**: 드롭다운에서 완제품 선택
2. **자품목 선택**: 드롭다운에서 원자재 선택
3. **소요량 입력**: 완제품 1개당 필요한 원자재 수량
   - 예: `2.5` (완제품 1개 = 원자재 2.5 단위)
4. **레벨 번호**: BOM 계층 구조 (기본값: 1)
5. **비고**: 추가 설명 (선택)

#### BOM 목록 표시 정보
- 모품목 정보 (품번, 품명)
- 자품목 정보 (품번, 품명)
- 소요량 (U/S)
- 레벨
- 상태 (활성/비활성)

### 10.3 생산 거래 화면 (`/inventory` → 생산 탭)

#### 화면 구성
- **생산 이력 목록**: 모든 생산입고/생산출고 거래
- **생산입고 추가 버튼**: 새 생산 등록
- **필터**: 거래일자, 제품, 거래유형

#### 생산입고 등록 폼

##### 기본 정보
1. **생산일자** (필수): 생산일자 선택
2. **생산오더 번호**: 자동 생성 버튼 제공
   - 형식: `PRD-YYYYMMDDHHMM`
3. **제품 선택** (필수): 
   - 검색 가능한 드롭다운
   - 품번 또는 품명으로 검색
4. **생산수량** (필수): 생산할 수량
5. **스크랩 수량**: 불량품 발생량 (선택)

##### BOM 설정
- **BOM 사용 체크박스**: 기본값 체크됨
  - 체크 시: BOM에 따라 자동 차감
  - 해제 시: 수동으로 원자재 출고 필요

##### 실시간 BOM 미리보기 패널
제품과 수량을 입력하면 **자동으로 표시**됩니다:

**요약 카드**:
- 총 자재 수
- 충족 품목 수
- 부족 품목 수
- 희망 생산수량
- 최대 생산가능 수량
- 부족 수량

**자재 상세 테이블**:
- 품목코드
- 품목명
- 소요량 (U/S): 완제품 1개당 필요량
- 필요수량: 생산수량 × 소요량
- 현재재고: 보유 재고
- 부족량: 필요수량 - 현재재고
- 이 자재로 생산가능: 현재재고 ÷ 소요량
- 상태: ✅ 충분 / ⚠️ 부족 / ❌ 없음

**경고 배너** (재고 부족 시):
- "재고 부족으로 생산 불가능"
- 최대 생산 가능 수량 표시
- 병목 자재 정보 표시

##### 배치 모드
- **배치 모드 토글**: 여러 제품을 한 번에 생산 등록
- **제품 추가 버튼**: 배치 목록에 제품 추가
- **전체 집계 탭**: 모든 제품의 자재 집계
- **개별 제품 탭**: 각 제품별 BOM 확인

### 10.4 생산 결과 모달

생산 등록 성공 시 표시되는 모달:

#### 생산 결과 요약
- 거래번호
- 생산수량
- 제품재고 변화 (+수량)
- 등록일시

#### 재고 부족 경고 (있는 경우)
- 최대 생산 가능 수량
- 부족 수량
- 부족한 원자재 목록

#### 자재 자동 차감 내역
- 품목코드
- 품목명
- 차감수량
- 차감 전 재고
- 차감 후 재고

---

## 14. 단계별 상세 시나리오

### 시나리오 1: 완전한 생산 프로세스 (재고 충분)

#### 1단계: 품목 등록

**완제품 등록**:
```
품번: CAR-001
품명: 자동차 부품 A
카테고리: 제품
단위: EA
현재 재고: 0
```

**원자재 등록**:
```
원자재 1:
- 품번: STEEL-001
- 품명: 철판 2mm
- 카테고리: 원자재
- 단위: KG
- 현재 재고: 1000

원자재 2:
- 품번: BOLT-001
- 품명: 볼트 M8
- 카테고리: 원자재
- 단위: EA
- 현재 재고: 5000
```

#### 2단계: BOM 설정

**BOM 1 추가**:
```
모품목: CAR-001 (자동차 부품 A)
자품목: STEEL-001 (철판 2mm)
소요량: 2.5
레벨: 1
```

**BOM 2 추가**:
```
모품목: CAR-001 (자동차 부품 A)
자품목: BOLT-001 (볼트 M8)
소요량: 4
레벨: 1
```

#### 3단계: 생산 등록

1. **생산입고 추가** 클릭
2. **생산일자**: 2025-11-27 선택
3. **제품 선택**: `CAR-001` 검색 후 선택
4. **생산수량**: `100` 입력
5. **BOM 사용**: ✅ 체크 (기본값)

**실시간 BOM 미리보기 표시**:
```
요약:
- 총 자재 수: 2
- 충족 품목: 2
- 부족 품목: 0
- 희망 생산수량: 100 EA
- 최대 생산가능: 100 EA ✅

자재 상세:
1. STEEL-001 (철판 2mm)
   - 소요량: 2.5 KG/EA
   - 필요수량: 250 KG
   - 현재재고: 1000 KG
   - 부족량: 0 KG
   - 상태: ✅ 충분

2. BOLT-001 (볼트 M8)
   - 소요량: 4 EA/EA
   - 필요수량: 400 EA
   - 현재재고: 5000 EA
   - 부족량: 0 EA
   - 상태: ✅ 충분
```

6. **생산 등록** 버튼 클릭

#### 4단계: 결과 확인

**생산 결과 모달**:
```
생산 결과:
- 거래번호: TXN-20251127001
- 생산수량: 100 EA
- 제품재고 변화: +100 EA

자재 자동 차감 내역:
1. STEEL-001 (철판 2mm)
   - 차감수량: -250 KG
   - 차감 전: 1000 KG
   - 차감 후: 750 KG

2. BOLT-001 (볼트 M8)
   - 차감수량: -400 EA
   - 차감 전: 5000 EA
   - 차감 후: 4600 EA
```

**재고 확인**:
- CAR-001: 0 → 100 EA ✅
- STEEL-001: 1000 → 750 KG ✅
- BOLT-001: 5000 → 4600 EA ✅

### 시나리오 2: 재고 부족 상황

#### 상황
- 완제품: CAR-001
- 생산 계획: 100 EA
- 현재 재고:
  - STEEL-001: 200 KG (필요: 250 KG)
  - BOLT-001: 5000 EA (필요: 400 EA)

#### 생산 등록 과정

1. **제품 선택**: CAR-001
2. **생산수량**: 100 입력

**BOM 미리보기 표시**:
```
⚠️ 경고 배너:
"재고 부족으로 생산 불가능"
- 최대 생산가능: 80 EA
- 희망 수량: 100 EA
- 부족 수량: 20 EA
- 병목 자재: STEEL-001 (철판 2mm)

자재 상세:
1. STEEL-001 (철판 2mm)
   - 필요수량: 250 KG
   - 현재재고: 200 KG
   - 부족량: 50 KG ⚠️
   - 이 자재로 생산가능: 80 EA
   - 상태: ⚠️ 부족

2. BOLT-001 (볼트 M8)
   - 필요수량: 400 EA
   - 현재재고: 5000 EA
   - 부족량: 0 EA
   - 이 자재로 생산가능: 1250 EA
   - 상태: ✅ 충분
```

#### 사용자 선택

**옵션 1: 수량 조정**
- 생산수량을 `80`으로 변경
- 모든 자재 충분 → 정상 생산

**옵션 2: 부족 상태로 생산 진행**
- 생산수량 `100` 유지
- **생산 등록** 버튼 클릭
- 버튼 텍스트: "재고 부족 - 그래도 생산 등록"

#### 결과

**생산 결과 모달**:
```
⚠️ 재고 부족 경고:
- 최대 생산가능: 80 EA
- 희망 수량: 100 EA
- 부족 수량: 20 EA

부족한 원자재:
• STEEL-001 (철판 2mm): 필요 250 KG / 현재 200 KG

자재 자동 차감 내역:
1. STEEL-001 (철판 2mm)
   - 차감수량: -200 KG (가능한 만큼만)
   - 차감 전: 200 KG
   - 차감 후: 0 KG
   - 부족: 50 KG 기록됨

2. BOLT-001 (볼트 M8)
   - 차감수량: -400 EA
   - 차감 전: 5000 EA
   - 차감 후: 4600 EA
```

**재고 확인**:
- CAR-001: 0 → 100 EA ✅
- STEEL-001: 200 → 0 KG (부족 50 KG 기록)
- BOLT-001: 5000 → 4600 EA ✅

**생산 이력 확인**:
- `/inventory` → 생산 탭
- 해당 거래의 **부족 총 수량**: 50 KG 표시
- 부족 내역 상세 확인 가능

---

## 15. 트러블슈팅

### 문제 1: BOM 미리보기가 표시되지 않음

**원인**:
- BOM이 등록되지 않음
- 제품 선택 안 함
- 생산수량이 0
- **품목 분류 설정 오류** ⭐

**해결**:
1. `/master/bom`에서 BOM 등록 확인
2. 제품 선택 확인
3. 생산수량 입력 확인
4. BOM 사용 체크박스 확인
5. **모품목의 품목 분류가 '제품' 또는 '완제품'인지 확인** ⭐

### 문제 2: 재고가 차감되지 않음

**원인**:
- BOM 사용 체크박스 해제
- Database Trigger 오류
- BOM이 비활성화됨
- **자품목의 품목 분류가 '원자재' 또는 '부자재'가 아님** ⭐

**해결**:
1. 생산 거래에서 BOM 사용 체크 확인
2. Database 로그 확인
3. BOM 활성화 상태 확인 (`is_active = true`)
4. **자품목의 품목 분류가 올바른지 확인** ⭐

### 문제 3: 재고 부족 경고가 표시되지 않음

**원인**:
- BOM 미리보기 로딩 중
- API 오류
- 네트워크 문제

**해결**:
1. 브라우저 콘솔 확인 (F12)
2. 네트워크 탭에서 API 호출 확인
3. 새로고침 버튼 클릭

### 문제 4: 부족 수량이 정확하지 않음

**원인**:
- BOM 소요량 오입력
- 재고 데이터 불일치

**해결**:
1. BOM 소요량 재확인
2. 재고 현황 페이지에서 실제 재고 확인
3. 재고 조정 필요 시 `/stock`에서 조정

### 문제 5: 배치 모드에서 BOM 확인이 안 됨

**원인**:
- 제품 선택 안 함
- 수량 입력 안 함
- BOM이 등록되지 않음
- **품목 분류 설정 오류** ⭐

**해결**:
1. 각 배치 항목의 제품 선택 확인
2. 각 배치 항목의 수량 입력 확인
3. 개별 제품 탭 클릭하여 BOM 확인
4. 전체 집계 탭에서 전체 자재 확인
5. **모든 제품의 품목 분류가 '제품' 또는 '완제품'인지 확인** ⭐

### 문제 6: 코일 필터가 작동하지 않음

**원인**:
- 자품목의 재고 분류가 '코일'로 설정되지 않음
- 소재 형태만 'COIL'로 설정하고 재고 분류는 설정 안 함

**해결**:
1. 자품목 편집
2. **재고 분류 = '코일'** 선택 ⭐
3. 소재 형태도 'COIL'로 설정 권장
4. BOM 관리 화면에서 "코일만 보기" 필터 확인

---

## 16. 고급 기능

### 13.1 배치 생산 모드

여러 제품을 한 번에 생산 등록:

1. **배치 모드 토글** 클릭
2. **제품 추가** 버튼으로 제품 추가
3. 각 제품별로:
   - 제품 선택
   - 생산수량 입력
   - 참조번호, 비고 입력 (선택)
4. **전체 집계 탭**: 모든 제품의 자재 집계 확인
5. **개별 제품 탭**: 각 제품별 BOM 확인
6. **생산 등록**: 모든 제품 한 번에 등록

**장점**:
- 여러 제품 동시 생산 시 효율적
- 전체 자재 소요량 한눈에 확인
- 중복 자재 자동 집계

### 13.2 BOM 미리보기 활용

생산 전 자재 소요량 확인:

1. **제품 선택** → 자동으로 BOM 조회
2. **생산수량 입력** → 실시간으로 필요 수량 계산
3. **자재 상세 테이블**:
   - 각 자재별 필요 수량
   - 현재 재고
   - 부족 여부
   - 최대 생산 가능 수량
4. **병목 자재 확인**: 최소 생산 가능 수량을 결정하는 자재

### 13.3 재고 부족 추적

생산 이력에서 부족 수량 확인:

1. `/inventory` → 생산 탭
2. 생산 거래 목록에서 **부족 총 수량** 컬럼 확인
3. 거래 클릭 → 상세 내역에서:
   - 부족한 자재 목록
   - 부족 수량
   - 차감 로그 확인

### 13.4 공정관리 활용

#### 공정 체인 관리

여러 공정을 연속으로 진행하는 경우:

1. **공정 1 등록**: BLANKING (코일 → 판지)
2. **공정 1 완료**: 판지 재고 증가
3. **공정 2 등록**: PRESS (판지 → 완제품)
   - 투입재료: 공정 1의 산출제품 선택
4. **공정 2 완료**: 완제품 재고 증가

#### 수율 분석

과거 공정 데이터를 기반으로 수율 분석:

1. 공정 목록에서 동일 공정 유형 필터링
2. 평균 수율 확인
3. 산출수량 자동 제안 활용

#### LOT 추적

생산 이력을 LOT 번호로 추적:

1. 공정 완료 시 생성된 LOT 번호 확인
2. 부모 LOT, 자식 LOT 관계 확인
3. 품질 이슈 발생 시 해당 LOT 추적

---

## 17. 관련 문서

- [BOM 템플릿 가이드](.example/BOM_TEMPLATE_COMPREHENSIVE_GUIDE.md)
- [재고 관리 가이드](README.md#재고-관리)
- [API 문서](README.md#주요-api)

---

**문서 작성**: Claude AI  
**최종 업데이트**: 2025-11-27  
**시스템 버전**: Phase 7 Complete

