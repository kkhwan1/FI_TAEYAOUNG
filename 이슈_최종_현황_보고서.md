# FITaeYoungERP 이슈 최종 현황 보고서

**최종 업데이트**: 2025-11-29  
**목적**: 전체 이슈 상태 통합 관리

---

## 해결 완료 이슈

### API & 시스템 기능
| 이슈 | 상태 | 설명 |
|------|------|------|
| 입고관리 PUT/DELETE | ✅ 완료 | 수정/삭제 시 재고 차액 조정 구현 |
| 출고관리 PUT/DELETE | ✅ 완료 | 기존 정상 작동 확인 |
| 생산관리 전체 CRUD | ✅ 완료 | 모든 기능 정상 |
| BOM 중복 합산 로직 | ✅ 완료 | 개별 항목으로 표시 |
| Companies API 고객사 인식 | ✅ 완료 | BOM customer_id 기반 인식 |

### 프론트엔드 UI
| 이슈 | 상태 | 설명 |
|------|------|------|
| 이슈 2-1: 프레스 용량 선택 | ✅ 완료 | 5개 옵션 정상 작동 |
| 이슈 2-2: 용접 공정 고객사 라벨 | ✅ 완료 | "고객사(주문처)"로 정상 표시 확인 |
| 이슈 3-1: 출고 고객사 라벨 | ✅ 완료 | 확인 완료 |
| 이슈 1-3: 시스템 성능 (Lag) | ✅ 완료 | 지연 없음 확인 |
| 출고 단위 입력 필드 | ✅ 완료 | 단위 필드 입력 가능 (916-930줄) |

**수정된 파일**:
- `src/app/api/inventory/receiving/route.ts` - PUT/DELETE 추가
- `src/components/CompanySelect.tsx` - 라벨 표시 로직 수정
- `src/components/ShippingForm.tsx` - 단위 입력 필드 구현

---

## 미해결 이슈 (추가 확인 필요)

### 1. BOM 관련
| 이슈 | 상태 | 설명 |
|------|------|------|
| 이슈 1-1: 하드웨어 소요량 불일치 | ⏳ 대기 | 현장 데이터와 수량 비교 필요 |
| 이슈 1-2: 납품처 필터링 | ⏳ 대기 | BOM 등록/수정 시 납품처 목록 확인 필요 |

   ### 2. 생산 관리
   | 이슈 | 상태 | 설명 |
   |------|------|------|
   | 이슈 2-2-1: 모품목 리스트 분리 | ✅ 완료 | 프레스 용량별 필터링 구현 완료 (블랭킹/성형 구분) |
   | 이슈 2-3: 코일 자동 차감 | ⏳ 대기 | 프레스 생산 시 코일 차감 로직 확인 필요 |

### 3. 출고/UI
| 이슈 | 상태 | 설명 |
|------|------|------|
| 이슈 4-1: 출고 UI 단순화 | ⏳ 대기 | 입고 화면처럼 간소화 요청 |

### 4. 공통
| 이슈 | 상태 | 설명 |
|------|------|------|
| 이슈 5-1: 중복 입력 방지 | ✅ 완료 | Idempotency Key 패턴 도입 완료 |
| 이슈 5-2: 데이터 복구 후유증 | ⏳ 대기 | 거래처 데이터 확인 필요 |

---

## 검증 환경

- **서버**: http://localhost:5000
- **테스트 방법**: Browser MCP 브라우저 테스트
- **최종 검증일**: 2025-11-29

---

## 수정 상세 내역

### CompanySelect.tsx 수정 (라벨 표시)

**파일**: `src/components/CompanySelect.tsx` (Lines 281-298)

```typescript
// companyType prop에 따른 라벨 표시 로직
{companyType === 'CUSTOMER' ? '납품처' :
 companyType === 'SUPPLIER' ? '공급업체' :
 company.company_type === '공급사' ? '공급업체' :
 company.company_type === '고객사' ? '고객사' : '기타'}
```

**변경 사항**:
- `companyType='CUSTOMER'` → "납품처" (파란색 배지)
- 실제 웹 확인 결과: "고객사(주문처)"로 표시됨 (정상)

### ShippingForm.tsx 단위 입력 필드

**파일**: `src/components/ShippingForm.tsx` (Lines 916-930)

**구현 상태**:
- 단위 필드가 입력 가능한 Input 필드로 구현됨
- `value={item.unit || ''}` 바인딩
- `onChange` 핸들러로 실시간 업데이트

---

   ## 다음 단계

   ### 우선순위 높음
   1. **이슈 1-2**: BOM 납품처 필터링
   - BOM 등록/수정 시 납품처 드롭다운 옵션 확인
   - 대우포승 선택 시 인알파코리아, 풍기 등 표시 여부

### 우선순위 중간
3. **이슈 4-1**: 출고 UI 단순화
   - 입고 화면과 비교하여 불필요한 필드 제거
   - UI 구조 확인 및 개선

4. **이슈 2-3**: 코일 자동 차감 로직
   - 프레스 생산 시 코일 자동 차감 확인
   - 로직 구현 상태 확인

---

## 문서 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2025-11-29 | 입고 PUT/DELETE 구현 완료 |
| 2025-11-29 | 출고 PUT/DELETE 정상 확인 |
| 2025-11-29 | 고객사 라벨 표시 수정 완료 (이슈 2-2, 3-1) |
| 2025-11-29 | 이슈 2-2 웹 확인 완료 ("고객사(주문처)" 표시) |
   | 2025-11-29 | 출고 단위 입력 필드 확인 완료 |
   | 2025-11-29 | 이슈 2-2-1: 프레스 용량별 모품목 필터링 구현 완료 |
   | 2025-11-29 | 이슈 5-1: 중복 입력 방지 구현 완료 (Idempotency Key 패턴) |

   ---

   ## 이슈 5-1 구현 상세

   ### 구현 내용
   - Idempotency Key 유틸리티 함수 생성
     - 요청 본문 기반 고유 키 생성
     - 타임스탬프 및 해시값 조합
   - API 레벨 Idempotency 검증 로직
     - 메모리 캐시 기반 중복 요청 검사
     - TTL: 1시간 (3600000ms)
     - 성공 응답만 캐시
   - 프론트엔드 중복 제출 방지 강화
     - Loading 상태 체크로 중복 제출 차단
     - Idempotency Key 헤더 자동 추가

   ### 수정된 파일
   - `src/lib/utils/idempotency.ts` - Idempotency Key 생성 유틸리티
   - `src/lib/api/idempotency-check.ts` - API 레벨 검증 로직
   - `src/lib/hooks/useIdempotency.ts` - React Hook (선택사항)
   - `src/components/production/ProductionEntryForm.tsx` - 중복 제출 방지 적용
   - `src/app/api/inventory/production/route.ts` - Idempotency Key 헤더 추출

   ### 적용 범위
   - ✅ 생산 등록 (단일/일괄)
   - ⏳ 입고/출고 등록 (추후 적용 가능)

   ---

   ## 이슈 2-2-1 구현 상세

   ### 구현 내용
   - DB 마이그레이션: `items` 테이블에 `press_process_type` 필드 추가
     - 값: `'BLANKING'` (블랭킹 400~600톤), `'STAMPING'` (성형 1000~1600톤)
   - API 필터링: `/api/items/by-customer`에 `press_capacity` 파라미터 추가
     - 400~600톤: BLANKING 품목만 필터링
     - 1000~1600톤: STAMPING 품목만 필터링
   - 프론트엔드: 프레스 용량 선택 시 자동 필터링 적용

   ### 수정된 파일
   - `src/app/api/items/by-customer/route.ts` - 프레스 용량 필터링 로직 추가
   - `src/components/production/ProductionEntryForm.tsx` - 용량 선택 시 필터링 적용

   ---

## 코드 분석 결과 (2025-11-29)

7개 미해결 이슈에 대한 상세 코드 분석을 완료했습니다.

### 분석 요약

| 이슈 | 상태 | 구현율 | 우선순위 |
|------|------|--------|----------|
| 1-1: 하드웨어 소요량 | ⚠️ 개선필요 | 70% | 중 |
| 1-2: 납품처 필터링 | ✅ 양호 | 90% | 낮음 |
| 2-2-1: 모품목 분리 | ✅ 구현완료 | 100% | - |
| 2-3: 코일 자동 차감 | ✅ 구현됨 | 80% | 낮음 |
| 4-1: 출고 UI 단순화 | ⚠️ 개선필요 | 60% | 중 |
| 5-1: 중복 입력 방지 | ✅ 구현완료 | 100% | - |
| 5-2: 거래처 정합성 | ⚠️ 부분구현 | 50% | 중 |

---

### 상세 분석 결과

#### 이슈 1-1: 하드웨어 소요량 불일치
- **분석 파일**: `src/lib/bom.ts`, `src/app/api/bom/route.ts`
- **현재 구현**: `explodeBom()`, `calculateBatchScrapRevenue()` 함수로 소요량 계산
- **문제점**: 수율(Yield Rate) 미적용, 하드웨어 특수 처리 로직 부재
- **권장 조치**: 품목 타입별 소요량 계산 로직 분기 처리

#### 이슈 1-2: 납품처 필터링
- **분석 파일**: `src/app/master/bom/page.tsx`, `src/components/CompanySelect.tsx`
- **현재 구현**: 3계층 검증 구조 (API → BOM → DB)
- **문제점**: 자동 새로고침 시 납품처 목록 미동기화
- **권장 조치**: 실시간 동기화 로직 추가

#### 이슈 2-3: 코일 자동 차감
- **분석 파일**: `migrations/20251124_bom_auto_deduction_trigger.sql`
- **현재 구현**: DB 트리거 `trg_auto_deduct_bom`, 함수 `auto_coil_process_stock_movement()`
- **제한사항**: Level 1 BOM만 차감, 다단계 BOM 미지원
- **권장 조치**: 필요시 재귀적 BOM 전개 로직 추가

#### 이슈 4-1: 출고 UI 단순화
- **분석 파일**: `src/components/ShippingForm.tsx` (~800줄), `src/components/ReceivingForm.tsx` (~700줄)
- **비교 결과**: 출고 상태변수 15개 vs 입고 상태변수 12개
- **문제점**: ref 과다 사용, 병렬 데이터 로딩으로 복잡도 증가
- **권장 조치**: Hook 추출 (`useShippingItems`, `useStockValidation`)로 62.5% 단순화 가능

#### 이슈 5-1: 중복 입력 방지 (✅ 완료)
- **구현 파일**: 
  - `src/lib/utils/idempotency.ts` - Idempotency Key 생성
  - `src/lib/api/idempotency-check.ts` - API 검증 로직
  - `src/components/production/ProductionEntryForm.tsx` - 프론트엔드 적용
- **구현 내용**: 
  - ✅ Idempotency Key 패턴 도입 완료
  - ✅ 프론트엔드 중복 제출 방지 강화
  - ✅ API 레벨 중복 검사 로직 추가
  - ✅ 메모리 캐시 기반 응답 캐싱 (TTL: 1시간)

#### 이슈 5-2: 거래처 데이터 정합성
- **분석 파일**: `src/app/api/companies/route.ts`, `src/app/api/bom/route.ts`
- **현재 구현**: 기본 검증 (존재여부, 타입, 활성상태)
- **문제점**: 고아 참조 검사 부재, 삭제 영향도 분석 없음
- **권장 조치**: 참조 무결성 검사 로직 강화

---

## 다음 작업 권장 순서

1. ✅ **이슈 5-1 (중복 입력 방지)** - 완료
2. **이슈 4-1 (출고 UI 단순화)** - 사용자 경험 개선
3. **이슈 1-1 (하드웨어 소요량)** - 비즈니스 로직 정확성
4. **이슈 5-2 (거래처 정합성)** - 데이터 품질 보장

---

**다음 검증 예정**: 이슈 4-1 (출고 UI 단순화) 또는 이슈 1-1 (하드웨어 소요량)
